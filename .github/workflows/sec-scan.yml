name: Security scan

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: security-scan-${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # 1. Scan normal dependencies
      # ----------------------------
      - name: Run Shai-Hulud scan on repo
        uses: gensecaihq/Shai-Hulud-2.0-Detector@v2
        with:
          fail-on-critical: true
          fail-on-high: true
          fail-on-any: false
          scan-lockfiles: true
          scan-node-modules: false
          output-format: json
          working-directory: '.'

      # --------------------------------------------------------
      # 2. Find ALL buildspec (.yml/.yaml) files recursively
      # --------------------------------------------------------
      - name: Find all buildspec files
        id: find_buildspecs
        run: |
          echo "Searching for buildspec files in the repo..."

          mapfile -t files < <(find . -type f \( \
            -name "buildspec.yml" -o \
            -name "buildspec.yaml" -o \
            -name "*-buildspec.yml" -o \
            -name "*-buildspec.yaml" \
          \))

          if (( ${#files[@]} == 0 )); then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "files=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found buildspec files:"
          printf '%s\n' "${files[@]}"

          # Convert list to compact JSON array
          json=$(printf '%s\n' "${files[@]}" | jq -R . | jq -s -c .)

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "files=$json" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------------
      # 3. Extract npm install commands from each buildspec file
      # --------------------------------------------------------
      - name: Parse npm install commands
        id: parse_npm
        if: ${{ steps.find_buildspecs.outputs.found == 'true' }}
        run: |
          mkdir -p parsed

          echo "Parsing npm install commands..."
          files='${{ steps.find_buildspecs.outputs.files }}'

          echo "$files" | jq -r '.[]' | while read file; do
            echo "Scanning $file ..."
            installs=$(grep -oP 'npm install[^\n]*' "$file" || true)

            if [[ -n "$installs" ]]; then
              echo "$installs" > "parsed/$(basename "$file").cmds"
            fi
          done

          if ls parsed/*.cmds >/dev/null 2>&1; then
            echo "found_npm=true" >> "$GITHUB_OUTPUT"
          else
            echo "found_npm=false" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------------
      # 4. Simulate npm installs for every buildspec file found
      # --------------------------------------------------------
      - name: Run npm installs from buildspec files
        if: ${{ steps.parse_npm.outputs.found_npm == 'true' }}
        run: |
          mkdir -p buildspec-scan

          for file in parsed/*.cmds; do
            dir="buildspec-scan/$(basename "$file")"
            mkdir -p "$dir"
            cd "$dir"

            echo "{}" > package.json

            echo "Running install commands from $file:"
            while read cmd; do
              echo "Executing: $cmd"
              eval "$cmd"
            done < "../../$file"

            cd ../../
          done

      # --------------------------------------------------------
      # 5. Scan dependencies from each simulated environment
      # --------------------------------------------------------
      - name: Scan dependencies installed from buildspec
        if: ${{ steps.parse_npm.outputs.found_npm == 'true' }}
        run: |
          for scan_dir in buildspec-scan/*; do
            echo "Scanning $scan_dir ..."
            gensecaihq/Shai-Hulud-2.0-Detector@v2 \
              --fail-on-critical true \
              --fail-on-high true \
              --fail-on-any false \
              --scan-lockfiles true \
              --scan-node-modules true \
              --output-format json \
              --working-directory "$scan_dir"
          done
